'use strict';
define(['jquery', 'flight/lib/component', '../ui/clusters', '../utils/map_utils', 'primedia_events'], function($, defineComponent, Clusters, map_utils, events) {
  var markersOverlay;
  markersOverlay = function() {
    this.defaultAttrs({
      searchGeoData: {},
      markers: [],
      markersIndex: {},
      gMap: void 0,
      markerClusterer: void 0,
      mapPin: map_utils.assetURL() + "/images/nonsprite/map/map_pin_red4.png",
      mapPinFree: map_utils.assetURL() + "/images/nonsprite/map/map_pin_free2.png",
      mapPinShadow: map_utils.assetURL() + "/images/nonsprite/map/map_pin_shadow3.png",
      markerOptions: {
        fitBounds: false
      }
    });
    this.initAttr = function(ev, data) {
      if (data.gMap) {
        this.attr.gMap = data.gMap;
      }
      if (data.mapPin) {
        this.attr.mapPin = data.mapPin;
      }
      if (data.mapPinFree) {
        this.attr.mapPinFree = data.mapPinFree;
      }
      if (data.mapPinShadow) {
        return this.attr.mapPinShadow = data.mapPinShadow;
      }
    };
    this.render = function(ev, data) {
      return this.addMarkers(data);
    };
    this.addMarkers = function(data) {
      var all_markers, i, len1, listing, m, ref;
      this.attr.markerClusterer.clearMarkers();
      this.attr.markers = [];
      this.attr.markersIndex = {};
      all_markers = [];
      ref = data.listings;
      for (i = 0, len1 = ref.length; i < len1; i++) {
        listing = ref[i];
        m = this.createMarker(listing);
        all_markers.push(m);
        this.sendCustomMarkerTrigger(m);
        this.attr.markers.push({
          googleMarker: m,
          markerData: listing
        });
        this.attr.markersIndex[listing.id] = this.attr.markers.length - 1;
      }
      this.attr.markerClusterer.addMarkers(all_markers);
      this.updateListingsCount();
      if (this.attr.markerOptions.fitBounds) {
        this.attr.markerClusterer.fitMapToMarkers();
      }
      return this.trigger('uiSetMarkerInfoWindow');
    };
    this.createMarker = function(datum) {
      return new google.maps.Marker({
        position: new google.maps.LatLng(datum.lat, datum.lng),
        map: this.attr.gMap,
        icon: this.iconBasedOnType(datum),
        shadow: this.shadowBaseOnType(datum),
        title: this.markerTitle(datum),
        datumId: datum.id
      });
    };
    this.sendCustomMarkerTrigger = function(marker) {
      var _this;
      _this = this;
      return google.maps.event.addListener(marker, 'click', function() {
        return $(document).trigger('markerClicked', {
          gMarker: this,
          gMap: _this.attr.gMap
        });
      });
    };
    this.currentMarker = function() {
      var len;
      len = this.attrs.markers.length;
      return this.attr.markers[len - 1];
    };
    this.markerTitle = function(datum) {
      return datum.name || '';
    };
    this.markerAnimation = function(ev, data) {
      var markerIndex, markerObject;
      if (!this.attr.markersIndex) {
        return;
      }
      markerIndex = this.attr.markersIndex[data.id.slice(7)];
      if (this.attr.markers[markerIndex]) {
        markerObject = this.attr.markers[markerIndex].googleMarker;
      }
      if (markerObject != null) {
        return markerObject.setAnimation(data.animation);
      }
    };
    this.updateListingsCount = function() {
      var lCount;
      lCount = this.attr.markers.length;
      return $("#mapview_listing_count").html("Apartments Found: " + lCount);
    };
    this.iconBasedOnType = function(datum) {
      if (datum.free) {
        return this.attr.mapPinFree;
      } else {
        return this.attr.mapPin;
      }
    };
    this.shadowBaseOnType = function(datum) {
      if (datum.free) {
        return "";
      } else {
        return this.attr.mapPinShadow;
      }
    };
    this.optimizedBasedOnHost = function() {
      if (window.location.hostname.match(/ci\.|local/)) {
        return false;
      } else {
        return true;
      }
    };
    this.getGeoDataForListing = function(listing) {
      return services.getGeoData({
        urlParameters: {
          city: (listing.propertycity ? listing.propertycity.replace(" ", "-") : ""),
          state: (listing.propertystatelong ? listing.propertystatelong.replace(" ", "-") : "")
        }
      });
    };
    this.initializeLeadForm = function() {
      if ($.isEmptyObject(this.attr.searchGeoData)) {
        return leadForm.init(this.attr.searchGeoData);
      } else {
        return $.when(this.getGeoDataForListing()).then(function(geoData) {
          return leadForm.init(geoData);
        });
      }
    };
    return this.after('initialize', function() {
      this.on(document, 'mapRenderedFirst', this.initAttr);
      this.on(document, 'markersUpdateAttr', this.initAttr);
      this.on(document, 'markersDataAvailable', this.render);
      this.on(document, 'uiMapZoom', this.updateListingsCount);
      this.on(document, 'animatePin', this.markerAnimation);
    });
  };
  return defineComponent(markersOverlay, Clusters);
});

//# sourceMappingURL=data:application/json;base64,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QXNDLElBQUMsQ0FBQSxNQUF2QyxDQUZBLENBQUE7QUFBQSxNQUdBLElBQUMsQ0FBQSxFQUFELENBQUksUUFBSixFQUFjLFdBQWQsRUFBMkIsSUFBQyxDQUFBLG1CQUE1QixDQUhBLENBQUE7QUFBQSxNQUlBLElBQUMsQ0FBQSxFQUFELENBQUksUUFBSixFQUFjLFlBQWQsRUFBNEIsSUFBQyxDQUFBLGVBQTdCLENBSkEsQ0FEbUI7SUFBQSxDQUFyQixFQWhHZTtFQUFBLENBQWpCLENBQUE7QUF3R0EsU0FBTyxlQUFBLENBQWdCLGNBQWhCLEVBQWdDLFFBQWhDLENBQVAsQ0FoSEM7QUFBQSxDQU5ILENBRkEsQ0FBQSIsImZpbGUiOiJ1aS9tYXJrZXJzLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmRlZmluZSBbXG4gICdqcXVlcnknLFxuICAnZmxpZ2h0L2xpYi9jb21wb25lbnQnLFxuICAnLi4vdWkvY2x1c3RlcnMnLFxuICAnLi4vdXRpbHMvbWFwX3V0aWxzJyxcbiAgJ3ByaW1lZGlhX2V2ZW50cydcbl0sIChcbiAgJFxuICAsZGVmaW5lQ29tcG9uZW50XG4gICxDbHVzdGVyc1xuICAsbWFwX3V0aWxzXG4gICxldmVudHNcbikgLT5cblxuICBtYXJrZXJzT3ZlcmxheSA9IC0+XG5cbiAgICBAZGVmYXVsdEF0dHJzXG4gICAgICAgc2VhcmNoR2VvRGF0YToge31cbiAgICAgICBtYXJrZXJzOiBbXVxuICAgICAgIG1hcmtlcnNJbmRleDoge31cbiAgICAgICBnTWFwOiB1bmRlZmluZWRcbiAgICAgICBtYXJrZXJDbHVzdGVyZXI6IHVuZGVmaW5lZFxuICAgICAgIG1hcFBpbjogbWFwX3V0aWxzLmFzc2V0VVJMKCkgKyBcIi9pbWFnZXMvbm9uc3ByaXRlL21hcC9tYXBfcGluX3JlZDQucG5nXCJcbiAgICAgICBtYXBQaW5GcmVlOiBtYXBfdXRpbHMuYXNzZXRVUkwoKSArIFwiL2ltYWdlcy9ub25zcHJpdGUvbWFwL21hcF9waW5fZnJlZTIucG5nXCJcbiAgICAgICBtYXBQaW5TaGFkb3c6IG1hcF91dGlscy5hc3NldFVSTCgpICsgXCIvaW1hZ2VzL25vbnNwcml0ZS9tYXAvbWFwX3Bpbl9zaGFkb3czLnBuZ1wiXG4gICAgICAgbWFya2VyT3B0aW9uczpcbiAgICAgICAgZml0Qm91bmRzOiBmYWxzZVxuXG4gICAgQGluaXRBdHRyID0gKGV2LCBkYXRhKSAtPlxuICAgICAgQGF0dHIuZ01hcCA9IGRhdGEuZ01hcCBpZiBkYXRhLmdNYXBcbiAgICAgIEBhdHRyLm1hcFBpbiA9IGRhdGEubWFwUGluIGlmIGRhdGEubWFwUGluXG4gICAgICBAYXR0ci5tYXBQaW5GcmVlID0gZGF0YS5tYXBQaW5GcmVlIGlmIGRhdGEubWFwUGluRnJlZVxuICAgICAgQGF0dHIubWFwUGluU2hhZG93ID0gZGF0YS5tYXBQaW5TaGFkb3cgaWYgZGF0YS5tYXBQaW5TaGFkb3dcblxuICAgIEByZW5kZXIgPSAoZXYsIGRhdGEpIC0+XG4gICAgICBAYWRkTWFya2VycyhkYXRhKVxuXG4gICAgQGFkZE1hcmtlcnMgPSAoZGF0YSkgLT5cbiAgICAgIEBhdHRyLm1hcmtlckNsdXN0ZXJlci5jbGVhck1hcmtlcnMoKVxuICAgICAgQGF0dHIubWFya2VycyA9IFtdXG4gICAgICBAYXR0ci5tYXJrZXJzSW5kZXggPSB7fVxuICAgICAgYWxsX21hcmtlcnMgPSBbXVxuXG4gICAgICBmb3IgbGlzdGluZyBpbiBkYXRhLmxpc3RpbmdzXG4gICAgICAgIG0gPSBAY3JlYXRlTWFya2VyKGxpc3RpbmcpXG4gICAgICAgIGFsbF9tYXJrZXJzLnB1c2gobSlcbiAgICAgICAgQHNlbmRDdXN0b21NYXJrZXJUcmlnZ2VyKG0pXG4gICAgICAgIEBhdHRyLm1hcmtlcnMucHVzaCB7Z29vZ2xlTWFya2VyOiBtLCBtYXJrZXJEYXRhOiBsaXN0aW5nfVxuICAgICAgICBAYXR0ci5tYXJrZXJzSW5kZXhbbGlzdGluZy5pZF0gPSBAYXR0ci5tYXJrZXJzLmxlbmd0aCAtIDFcblxuICAgICAgQGF0dHIubWFya2VyQ2x1c3RlcmVyLmFkZE1hcmtlcnMoYWxsX21hcmtlcnMpXG4gICAgICBAdXBkYXRlTGlzdGluZ3NDb3VudCgpXG4gICAgICBAYXR0ci5tYXJrZXJDbHVzdGVyZXIuZml0TWFwVG9NYXJrZXJzKCkgaWYgQGF0dHIubWFya2VyT3B0aW9ucy5maXRCb3VuZHNcbiAgICAgIEB0cmlnZ2VyICd1aVNldE1hcmtlckluZm9XaW5kb3cnXG5cbiAgICBAY3JlYXRlTWFya2VyID0gKGRhdHVtKSAtPlxuICAgICAgbmV3IGdvb2dsZS5tYXBzLk1hcmtlcihcbiAgICAgICAgcG9zaXRpb246IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoZGF0dW0ubGF0LCBkYXR1bS5sbmcpXG4gICAgICAgIG1hcDogQGF0dHIuZ01hcFxuICAgICAgICBpY29uOiBAaWNvbkJhc2VkT25UeXBlKGRhdHVtKVxuICAgICAgICBzaGFkb3c6IEBzaGFkb3dCYXNlT25UeXBlKGRhdHVtKVxuICAgICAgICB0aXRsZTogQG1hcmtlclRpdGxlKGRhdHVtKSAjIEBzZXRMaXN0aW5nVGl0bGVCYXNlT25Ib3N0KGxpc3RpbmcpXG4gICAgICAgIGRhdHVtSWQ6IGRhdHVtLmlkXG4gICAgICApXG5cbiAgICBAc2VuZEN1c3RvbU1hcmtlclRyaWdnZXIgPSAobWFya2VyKSAtPlxuICAgICAgX3RoaXMgPSB0aGlzXG4gICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lciBtYXJrZXIsICdjbGljaycsIC0+XG4gICAgICAgICQoZG9jdW1lbnQpLnRyaWdnZXIgJ21hcmtlckNsaWNrZWQnLCBnTWFya2VyOiBALCBnTWFwOiBfdGhpcy5hdHRyLmdNYXBcblxuICAgIEBjdXJyZW50TWFya2VyID0gKCkgLT5cbiAgICAgIGxlbiA9IEBhdHRycy5tYXJrZXJzLmxlbmd0aFxuICAgICAgQGF0dHIubWFya2Vyc1tsZW4gLSAxXVxuXG4gICAgQG1hcmtlclRpdGxlID0gKGRhdHVtKSAtPlxuICAgICAgZGF0dW0ubmFtZSB8fCAnJ1xuXG4gICAgQG1hcmtlckFuaW1hdGlvbiA9IChldiwgZGF0YSkgLT5cbiAgICAgIHJldHVybiB1bmxlc3MgQGF0dHIubWFya2Vyc0luZGV4XG4gICAgICBtYXJrZXJJbmRleCA9IEBhdHRyLm1hcmtlcnNJbmRleFtkYXRhLmlkLnNsaWNlKDcpXVxuICAgICAgbWFya2VyT2JqZWN0ID0gQGF0dHIubWFya2Vyc1ttYXJrZXJJbmRleF0uZ29vZ2xlTWFya2VyIGlmIEBhdHRyLm1hcmtlcnNbbWFya2VySW5kZXhdXG4gICAgICBpZiBtYXJrZXJPYmplY3Q/XG4gICAgICAgIG1hcmtlck9iamVjdC5zZXRBbmltYXRpb24oZGF0YS5hbmltYXRpb24pXG5cbiAgICBAdXBkYXRlTGlzdGluZ3NDb3VudCA9IC0+XG4gICAgICBsQ291bnQgPSBAYXR0ci5tYXJrZXJzLmxlbmd0aFxuICAgICAgJChcIiNtYXB2aWV3X2xpc3RpbmdfY291bnRcIikuaHRtbCBcIkFwYXJ0bWVudHMgRm91bmQ6IFwiICsgbENvdW50XG5cbiAgICAjIFRoZXNlIGZ1bmN0aW9ucyBzaG91bGQgYmUgbW92ZWQgdG8gTGlzdGluZyBjb21wb25lbnRcbiAgICBAaWNvbkJhc2VkT25UeXBlID0gKGRhdHVtKSAtPlxuICAgICAgaWYgZGF0dW0uZnJlZSB0aGVuIEBhdHRyLm1hcFBpbkZyZWUgZWxzZSBAYXR0ci5tYXBQaW5cblxuICAgIEBzaGFkb3dCYXNlT25UeXBlID0gKGRhdHVtKSAtPlxuICAgICAgaWYgZGF0dW0uZnJlZSB0aGVuIFwiXCIgZWxzZSBAYXR0ci5tYXBQaW5TaGFkb3dcblxuICAgIEBvcHRpbWl6ZWRCYXNlZE9uSG9zdCA9ICgpIC0+XG4gICAgICBpZiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUubWF0Y2goL2NpXFwufGxvY2FsLykgdGhlbiBmYWxzZSBlbHNlIHRydWVcblxuICAgIEBnZXRHZW9EYXRhRm9yTGlzdGluZyA9IChsaXN0aW5nKSAtPlxuICAgICAgc2VydmljZXMuZ2V0R2VvRGF0YSh1cmxQYXJhbWV0ZXJzOlxuICAgICAgICBjaXR5OiAoaWYgbGlzdGluZy5wcm9wZXJ0eWNpdHkgdGhlbiBsaXN0aW5nLnByb3BlcnR5Y2l0eS5yZXBsYWNlKFwiIFwiLCBcIi1cIikgZWxzZSBcIlwiKVxuICAgICAgICBzdGF0ZTogKGlmIGxpc3RpbmcucHJvcGVydHlzdGF0ZWxvbmcgdGhlbiBsaXN0aW5nLnByb3BlcnR5c3RhdGVsb25nLnJlcGxhY2UoXCIgXCIsIFwiLVwiKSBlbHNlIFwiXCIpKVxuXG4gICAgQGluaXRpYWxpemVMZWFkRm9ybSA9ICgpIC0+XG4gICAgICBpZiAkLmlzRW1wdHlPYmplY3QoQGF0dHIuc2VhcmNoR2VvRGF0YSlcbiAgICAgICAgbGVhZEZvcm0uaW5pdCBAYXR0ci5zZWFyY2hHZW9EYXRhXG4gICAgICBlbHNlXG4gICAgICAgICQud2hlbihAZ2V0R2VvRGF0YUZvckxpc3RpbmcoKSkudGhlbiAoZ2VvRGF0YSkgLT5cbiAgICAgICAgICBsZWFkRm9ybS5pbml0IGdlb0RhdGFcblxuICAgIEBhZnRlciAnaW5pdGlhbGl6ZScsIC0+XG4gICAgICBAb24gZG9jdW1lbnQsICdtYXBSZW5kZXJlZEZpcnN0JywgQGluaXRBdHRyXG4gICAgICBAb24gZG9jdW1lbnQsICdtYXJrZXJzVXBkYXRlQXR0cicsIEBpbml0QXR0clxuICAgICAgQG9uIGRvY3VtZW50LCAnbWFya2Vyc0RhdGFBdmFpbGFibGUnLCBAcmVuZGVyXG4gICAgICBAb24gZG9jdW1lbnQsICd1aU1hcFpvb20nLCBAdXBkYXRlTGlzdGluZ3NDb3VudFxuICAgICAgQG9uIGRvY3VtZW50LCAnYW5pbWF0ZVBpbicsIEBtYXJrZXJBbmltYXRpb25cbiAgICAgIHJldHVyblxuXG4gIHJldHVybiBkZWZpbmVDb21wb25lbnQobWFya2Vyc092ZXJsYXksIENsdXN0ZXJzKVxuIl19